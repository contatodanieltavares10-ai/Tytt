import cv2
import numpy as np
from PIL import Image, ImageDraw, ImageFont

def criar_mockup_completo():
    # --- CONFIGURAÇÕES (Edite aqui) ---
    caminho_imagem_fundo = "outdoor.jpg"  # Sua foto do outdoor
    texto_mockup = "BASE AGÊNCIA"
    
    # Coordenadas dos 4 cantos do outdoor na SUA foto original
    # Ordem: [Topo-Esquerdo, Topo-Direito, Base-Direita, Base-Esquerda]
    # Você precisa descobrir esses pixels na sua imagem (use o Paint para ver)
    coordenadas_outdoor = np.float32([
        [225, 130],  # Ponto 1: Superior Esquerdo
        [580, 180],  # Ponto 2: Superior Direito
        [580, 450],  # Ponto 3: Inferior Direito
        [225, 520]   # Ponto 4: Inferior Esquerdo
    ])
    
    # -----------------------------------------------------------
    # PASSO 1: CRIAR A ARTE DIGITAL (Usando PILLOW)
    # -----------------------------------------------------------
    largura_arte, altura_arte = 800, 400
    cor_laranja = (255, 102, 0) # RGB
    
    # Cria imagem laranja
    img_pil = Image.new('RGB', (largura_arte, altura_arte), color=cor_laranja)
    draw = ImageDraw.Draw(img_pil)
    
    # Configura a fonte (tenta Arial, senão usa padrão)
    try:
        font = ImageFont.truetype("arial.ttf", 60)
    except IOError:
        font = ImageFont.load_default()
        print("Aviso: Fonte Arial não encontrada, usando padrão.")

    # Centraliza o texto
    bbox = draw.textbbox((0, 0), texto_mockup, font=font)
    w_texto, h_texto = bbox[2] - bbox[0], bbox[3] - bbox[1]
    pos_x = (largura_arte - w_texto) / 2
    pos_y = (altura_arte - h_texto) / 2
    
    # Escreve o texto em branco
    draw.text((pos_x, pos_y), texto_mockup, font=font, fill=(255, 255, 255))
    
    # Converte do Pillow (RGB) para OpenCV (BGR) para podermos processar
    img_arte = cv2.cvtColor(np.array(img_pil), cv2.COLOR_RGB2BGR)

    # -----------------------------------------------------------
    # PASSO 2: APLICAR PERSPECTIVA (Usando OPENCV)
    # -----------------------------------------------------------
    img_fundo = cv2.imread(caminho_imagem_fundo)
    if img_fundo is None:
        print("Erro: Não encontrei a imagem 'outdoor.jpg'.")
        return

    h_bg, w_bg = img_fundo.shape[:2]

    # Define os cantos da arte plana (origem)
    pts_src = np.float32([
        [0, 0],                       # Topo-Esq
        [largura_arte, 0],            # Topo-Dir
        [largura_arte, altura_arte],  # Base-Dir
        [0, altura_arte]              # Base-Esq
    ])

    # Calcula a matriz de transformação (Matemática mágica da perspectiva)
    matriz = cv2.getPerspectiveTransform(pts_src, coordenadas_outdoor)

    # Deforma a arte laranja para caber na perspectiva
    img_warped = cv2.warpPerspective(img_arte, matriz, (w_bg, h_bg))

    # Cria uma máscara (o formato do outdoor em branco sobre fundo preto)
    mask = np.zeros((h_bg, w_bg), dtype=np.uint8)
    cv2.fillConvexPoly(mask, coordenadas_outdoor.astype(int), 255)

    # Inverte a máscara
    mask_inv = cv2.bitwise_not(mask)

    # "Recorta" o buraco do outdoor na foto original
    fundo_com_buraco = cv2.bitwise_and(img_fundo, img_fundo, mask=mask_inv)
    
    # "Recorta" apenas a arte deformada
    arte_recortada = cv2.bitwise_and(img_warped, img_warped, mask=mask)

    # Soma as duas imagens
    resultado_final = cv2.add(fundo_com_buraco, arte_recortada)

    # -----------------------------------------------------------
    # PASSO 3: MOSTRAR E SALVAR
    # -----------------------------------------------------------
    cv2.imshow("Mockup BASE AGENCIA", resultado_final)
    cv2.imwrite("mockup_base.jpg", resultado_final)
    print("Sucesso! Imagem salva como 'mockup_base.jpg'")
    
    cv2.waitKey(0)
    cv2.destroyAllWindows()

if __name__ == "__main__":
    criar_mockup_completo()

